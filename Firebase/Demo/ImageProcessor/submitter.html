<html>

<head>
</head>

<body>

	<script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
	<script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-database.js"></script>
	<script src="../../fireHive.js" type="text/javascript"></script>

	<form id="form">
		<input id="file" type="file" multiple disabled />
	</form>
	<table id="output"></table>

	<script type="text/javascript">

		const input = document.getElementById('file');
		if (hive) {
			let config = {
				apiKey: " AIzaSyA-Y_mz58xgvGkQNK_tQCXQiG3q1mlA6hM",
				authDomain: "hive-1336.firebaseapp.com",
				databaseURL: "https://hive-1336.firebaseio.com/",
				storageBucket: "hive-1336.appspot.com"
			};
			hive.start(config,
				function () {
					console.log("Hive started");
					document.getElementById("file").disabled = false;
					document.getElementById("file").onchange = processImage;
					function processImage() {
						loadImage().then(scaleToMaxSize).then(requestImageProcessing);
					}
					function loadImage() {
						return new Promise((res, rej) => {
							if (input.files && input.files[0]) {
								var reader = new FileReader();

								reader.onload = function (e) {
									res(e.target.result);
									document.getElementById("form").reset();
									//$('#blah').attr('src', e.target.result);
								}
								reader.onerror = rej;
								reader.readAsDataURL(input.files[0]);
							} else { rej() }
						});

					}
					const maxDimention = 800;


					function scaleToMaxSize(b64) {
						return new Promise((res, rej) => {
							var img = new Image();
							let canvas = document.createElement("canvas");
							let context = canvas.getContext('2d');

							img.onload = function () {
								let width = img.width;
								let height = img.height;
								let scale = Math.min(maxDimention / width, maxDimention / height);
								if (scale > 1) scale = 1;
								width *= scale;
								height *= scale;
								canvas.width = width;
								canvas.height = height;
								context.drawImage(img, 0, 0, width, height);
								res(canvas.toDataURL("image/png"));
							};
							img.src = b64;
						});

					}

					function requestImageProcessing(b64) {
						const outputTable = document.getElementById('output');
						let img = document.createElement("img");
						img.src = b64;
						img.height = 50;
						let row = document.createElement("tr");
						let data = document.createElement("td");
						let resultData = document.createElement("td");
						data.appendChild(img);
						row.appendChild(data);
						row.appendChild(resultData);
						outputTable.appendChild(row);
						hive.request("imageProcessing", b64).then((r) => {
							let img = document.createElement("img");
							img.src = r;
							img.height = 50;
							resultData.appendChild(img);
						});
					}
				});
		} else {
			console.log("Hive was not defined");
		}
	</script>
</body>

</html>