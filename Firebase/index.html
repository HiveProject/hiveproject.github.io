<html>
<head></head>
<body>
<script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-database.js"></script>
<script src="watch.js" type="text/javascript"></script>
<script>

Map.prototype.getKey=function(inputValue)
{
	for (var [key, value] of this) { 
		if(value==inputValue) return key
	}
	return undefined;
}

  // Set the configuration for your app
  // TODO: Replace with your project's config object
  var config = {
    apiKey: " AIzaSyA-Y_mz58xgvGkQNK_tQCXQiG3q1mlA6hM",
    authDomain: "hive-1336.firebaseapp.com",
    databaseURL: "https://hive-1336.firebaseio.com/",
    storageBucket: "hive-1336.appspot.com"
  };
  firebase.initializeApp(config);

  // Get a reference to the database service
  var database = firebase.database();
  var loadedObjects= new Map();
  function Remove(obj)
  {
	var id= loadedObjects.getKey(obj);
	if(id)
	{ 
		database.ref('test/' +id).set(null);
	}
  }
  function Add(obj){
	if(loadedObjects.has(obj))
	{
		return loadedObjects.get(obj);
	}
	//watching.
	
	enableWatch(obj);
	var key= database.ref("test").push().key; 
	loadedObjects.set(obj,key);
	var data = {};
	for (var k in obj) {
		if(obj[k]!=null){
			data[k] = {
				type:obj[k].constructor.name 
			};
			if(data[k].type=="Object"){
			
				data[k].value=	Add(obj[k]);
			}else if(data[k]!="Function"){
				data[k].value=obj[k];
			}else{
				
			}
		}
    }
	database.ref("test/"+key ).set(data);
	return key;	
}
function childAdded(dataSnapshot)
{
	if(!loadedObjects.has(dataSnapshot.key))
	{
		var obj = {};
		var received=dataSnapshot.val();
		for (var k in received) {
			if(received[k]!=null){
				if(received[k].type=="Object")
				{ 
					//if the object is not in my cache, i might have some sync issues here.
					obj[k]=loadedObjects.get(received[k].value);
				}else{
					//let's say this is a literal for now.
					obj[k]=received[k].value;
				}
			} 
		}
		loadedObjects.set(dataSnapshot.key,obj);
		enableWatch(obj);
	}
}

function enableWatch(obj)
{
	watch(obj,
	function(fieldName,operation,newValue,oldValue){
		if(newValue!=oldValue){
			UpdateField(this,fieldName);
		}
	});
}
function childRemoved(oldDataSnapshot)
{
	unwatch(loadedObjects.get(oldDataSnapshot.key));
	loadedObjects.delete(oldDataSnapshot.key);
}
function childChanged(dataSnapshot)
{
	var obj = loadedObjects.get(dataSnapshot.key);
	var received=dataSnapshot.val();
	for (var k in received) {
		if(received[k]!=null){
			if(received[k].type=="Object")
			{ 
				//if the object is not in my cache, i might have some sync issues here.
				var other = loadedObjects.get(received[k].value);
				if(obj[k]!=other);
				{obj[k]=other;}
			}else{
				//let's say this is a literal for now.
				if(obj[k]!=received[k].value)
				{
				//	unwatch(obj);
					obj[k]=received[k].value;
				//	enableWatch(obj);
				}
			}
		} 
	}
}

function UpdateField(obj,fieldName)
{
	var upd={};
	var id = loadedObjects.getKey(obj);
	if(id)
	{		
		var basePath = "/"+id+"/"+fieldName+"/"; 
		var type = obj[fieldName].constructor.name;
		
		upd[basePath+"type"]=type;
		if(type=="Object")
		{
			upd[basePath+"value"]=Add(obj[fieldName]);
		}else{
			upd[basePath+"value"]=obj[fieldName]; 
		}
		database.ref("test").update(upd);
	}
}
database.ref("test").on("child_added",childAdded);
database.ref("test").on("child_removed",childRemoved);
database.ref("test").on("child_changed",childChanged);
</script>
</body></html>
