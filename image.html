<html>
	<head>
		<link rel="stylesheet" type="text/css" 
			href="https://fonts.googleapis.com/css?family=Source Code Pro">
		<style>
			body {
				font-family: 'Source Code Pro', serif !important;
				font-size: 14px !important;
			}
						
            #repl_in {
				width: 100% !important;
            }
			
			#repl_out {
				white-space: pre-wrap !important;
			}
            
			.expr {
				font-weight: bold !important;
			}		
		</style>
		<style>
        </style>		
		<!-- Bootstrap core CSS -->
		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<!-- Bootstrap theme -->
		<link href="bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
		<!-- Bootstrap-notify -->
		<link href="bootstrap/css/bootstrap-notify.css" rel="stylesheet">
		
		<link href="css/styles.css" rel="stylesheet">
		<script src="https://use.fontawesome.com/129aa955e7.js"></script>
		
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<script src="realtime.Sugar.js"></script>
		
		
	</head>
	<body style="margin-left: 10px;margin-right: 10px;">
	
		<a class="btn btn-default" href="index.html"><i class="fa fa-folder-open fa-lg"></i> Back</a>
		<a id="auth_button" class="btn btn-default" ><i class="fa fa-key fa-lg"></i> Authorize</a> 
		<div id="controls">
			<p>
				<textarea id="repl_in" type="text" rows="5"
					onkeypress="if(event.which === 10 && event.ctrlKey) repl_eval();"></textarea>
			</p>
			<p>
			
				<a class="btn btn-default"onclick="repl_parse()" ><i class="fa fa-align-justify fa-lg"></i> Parse</a> 
			 	<a class="btn btn-default"onclick="repl_compile()" ><i class="fa fa-list fa-lg"></i> Compile</a> 
			 	<a class="btn btn-default"onclick="repl_eval()" ><i class="fa fa-indent fa-lg"></i> Eval</a>  
			</p>
        </div>
        <p id="repl_out"></p>  
		
		<script src="parser/parser.js"></script>
		<script src="compiler.js"></script>
		<script>
			var loaded = false;
			
			function repl_parse(src) {
				if (src === undefined) {
					src = repl_in.value;
					repl_in.value = "";
				}
				repl_show(src, JSON.stringify(parser.parse(src)));
			}
			
			function repl_compile(src) {
				if (src === undefined) {
					src = repl_in.value;
					repl_in.value = "";
				}
				repl_show(src, compiler.compile(src));
			}
						
			function repl_eval(src) {
				if (!loaded) {
					console.log("The system is not initialized yet.");
					repl_show(src, "The system is not initialized yet.");
					return;
				}
				if (src === undefined) {
					src = repl_in.value;
					repl_in.value = "";
				}
				try {
					repl_show(src, compiler.evaluate(src).toString());
				} catch (ex) {
					repl_show(src, ex.toString());
				}
			}
		
            function repl_show(expr, result) {
                var p = document.createElement("p");
				split(expr).forEach(function (line, index) {				
					var exprDiv = document.createElement("div");
					exprDiv.setAttribute("class", "expr");
					exprDiv.textContent = (index == 0 ? ">>  " : "    ") + line;
					p.appendChild(exprDiv);
				});
				split(result).forEach(function (line) {				
					var resDiv = document.createElement("div");
					resDiv.setAttribute("class", "result");
					resDiv.textContent = line;
					p.appendChild(resDiv);
				});
                repl_out.insertBefore(p, repl_out.firstChild);
            }
			
			function split(str) {
				return str.match(/[^\r\n]+/g);
			}
		</script>
		<script>
			var context;
			
			function setButton() {
				var button = document.getElementById('auth_button');
				button.style.visibility="visible";
				button.addEventListener('click', authorize);
			}
			
			function unSetButton() {
				var button = document.getElementById('auth_button');
				button.style.visibility="hidden";
			}
			
			function authorize() {
				// Attempt to authorize
				realtimeUtils.authorize(function(response) {
					if(response.error) {
						// Authorization failed because this is the first time the user has used your application,
						// show the authorize button to prompt them to authorize manually.
						setButton();
					} else {
						unSetButton();
						start(hiveLoaded);
					}
				}, true);
			}
			
			authCallback = authorize;
	 
			function hiveLoaded(model) {
				if(model.getRoot().get('context') == null) {
					initializeObjects();
				} else { 
					context = model.getRoot().get('context');
				}
				openModelViewer();
				loaded = true;
			}
						
			// startups the system
			function initializeObjects() {
			  
				context = CreateContext();
				 
				model.getRoot().set('context',context);
				
				context.set('object', model.createMap());
			 
				context.get('object').set('basicNew', CreateMethod(
					'basicNew',"(function () { var self = model.createMap();context.set('self',self); initObject(self,context);return self;})",context));
				
				compiler.evaluate("null := (object basicNew addMethod:[isNull| true]) addMethod:[toString|'null']")
				InitializeNumbers();
				InitializeStrings();
				InitializeLists();
				InitializeOthers();
			}
			
			function initObject(obj,context) {
				obj.set('addMethod:',CreateMethod(
					'addMethod:',"(function(b){context.lookup('self').get().set(b.get('selector'),b); return context.lookup('self').get();})",context));
				obj.set('toString',CreateMethod('toString',"(function(){ return CreateString('An Object');})",context));
				obj.set('Equals:',CreateMethod(
					'Equals:',"(function(other){if(context.lookup('self').get()==other){return context.lookup('true').get();}else{return context.lookup('false').get();}})",context));
				
				obj.set('isNull',CreateMethod('isNull',"(function(){ return context.lookup('false').get();})",context));		
			}
			
			function InitializeNumbers() {
				compiler.evaluate("Number := object basicNew");
				
				compiler.evaluate("Number addMethod:[value | self]");
				context.get('Number').set('+', CreateMethod(
					'+',"(function (b) {return (context.lookup('self').get() + b);})",context));
				context.get('Number').set('/', CreateMethod(
					'/',"(function (b) {return (context.lookup('self').get() / b);})",context));
				
				context.get('Number').set('+', CreateMethod(
					'-',"(function (b) {return (context.lookup('self').get() - b);})",context));
				context.get('Number').set('/', CreateMethod(
					'*',"(function (b) {return (context.lookup('self').get() * b);})",context));
				

				//compiler.evaluate("Number addMethod:[* b | self / (1/b) ]");
				//compiler.evaluate("Number addMethod:[- b | self + (-1 * b) ]");
				
				context.get('Number').set('>', CreateMethod(
					'>',"(function (b) {if(context.lookup('self').get() > b){return context.lookup('true').get();}else{return context.lookup('false').get();}})",context));
				context.get('Number').set('<', CreateMethod(
					'<',"(function (b) {if(context.lookup('self').get() < b){return context.lookup('true').get();}else{return context.lookup('false').get();}})",context));
				
				compiler.evaluate("Number addMethod:[>= b | (self < b) Not ]");
				
				compiler.evaluate("Number addMethod:[<= b | (self > b) Not ]");
				compiler.evaluate("Number addMethod:[=b | self Equals:b]");
				context.get('Number').set('toString',CreateMethod('toString',"(function(){ return CreateString(context.lookup('self').get().toString());})",context));
			}
			
			function InitializeStrings() {
				compiler.evaluate("String := object basicNew");
				compiler.evaluate("String addMethod:[toString | self]");
				compiler.evaluate("String addMethod:[value | self]");
				
				//concat
				context.get('String').set('+', CreateMethod(
					'+',"(function (b) {return (model.createString(context.lookup('self').get().toString() + b.receive('toString')().text));})",context));  
				//append
				context.get('String').set('+=', CreateMethod(
					'+=',"(function (b) {context.lookup('self').get().append(b.receive('toString')().text);return (context.lookup('self').get());})",context)); 
				//length
				context.get('String').set('length', CreateMethod(
					'length',"(function () {return (context.lookup('self').get().length);})",context)); 
				//toList
				context.get('String').set('toList', CreateMethod(
					'toList',"(function () {return (model.createList(context.lookup('self').get().text));})",context)); 			
			}
			
			function InitializeLists() {
				compiler.evaluate("List := object basicNew");
			
				context.get('List').set('at:', CreateMethod(
					'at:',"(function (index) {var s=context.lookup('self').get(); if(index>=s.length){return context.lookup('null').get();} return s.get(index); })",context));
				
				context.get('List').set('at:put:', CreateMethod(
					'at:put:',"(function (index,value) { var s=context.lookup('self').get(); while(index>=s.length){s.push(context.lookup('null').get());} context.lookup('self').get().set(index,value); return context.lookup('self').get(); })",context));
					
				context.get('List').set('count', CreateMethod(
					'count',"(function () {return context.lookup('self').get().length; })",context));
				
				context.get('List').set('removeAt:', CreateMethod(
					'removeAt:',"(function (index) {var s =context.lookup('self').get(); s.remove(index); return s; })",context));
				compiler.evaluate('List addMethod:[pop| r:= self at:(self count-1). self removeAt:(self count-1). r].List addMethod:[push: value| self at:(self count) put: value].');				
				
				
				context.get('List').set('do:', CreateMethod(
					'do:',"(function (aBlock) {var s =context.lookup('self').get(); for(var i=0;i<s.length;i++){ aBlock.receive('valueWithArguments:')(model.createList([s.get(i)]));} return s; })",context));
				compiler.evaluate(" List addMethod:[select: aBlock | |temp|  temp := {}.  self do:[:each | temp push:( aBlock valueWithArguments: {each})]]");
				compiler.evaluate("List addMethod: [toString || str index | str := '{'. index := 0. self do: [:each | index = 0 ifFalse: [str += ' . ']. str += each toString. index := index + 1]. str += '}'. str]");
			}
			
			function InitializeOthers() {		 
				compiler.evaluate("true := ((object basicNew addMethod:[ifTrue:aBlock| aBlock value]) addMethod:[ifFalse:aBlock| ]) addMethod:[ifTrue: aBlock ifFalse: anotherBlock| aBlock value]");
				compiler.evaluate("true addMethod:[toString|'true']. true addMethod:[value|true]");
				compiler.evaluate("false := ((object basicNew addMethod:[ifTrue:aBlock| ]) addMethod:[ifFalse:aBlock| aBlock value]) addMethod:[ifTrue: aBlock ifFalse: anotherBlock| anotherBlock value]");
				compiler.evaluate("false addMethod:[toString|'false']. false addMethod:[value|false]")
				
				//logical operators
				compiler.evaluate("true addMethod:[Not| false]. true addMethod:[And: other| other value]. true addMethod:[Or: other| true].");
				compiler.evaluate("false addMethod:[Not| true]. false addMethod:[And: other| false]. false addMethod:[Or: other| other value].");		
			}
		</script>
		<script>
			function HiveEval(context, str) {
				return eval(str);
			}
		
			function CreateString(str) {
				return model.createString(str);
			}
		
			function CreateMethod(selector,func,context) { 
				var method= model.createMap();
				method.set('context', context);
				method.set('source', func);
				method.set("selector", selector);
				method.set("value", method);
				
				var valctx = CreateContext(context);
				valctx.set('self',method);
				var valWithArgs = model.createMap();
				valWithArgs.set('context', valctx);
				valWithArgs.set('selector', 'valWithArguments:');
				valWithArgs.set('source', "(function (args) {var s =context.lookup('self').get(); var func = HiveEval(context,s.get('source'));return func.apply(this,args.asArray());})");
				method.set('valueWithArguments:', valWithArgs);
				return method;
			}

			function CreateContext(parent) {
				var context = model.createMap();
				if(parent!=null) {
					context.set('parent',parent);
				}
				return context;
			}
		</script>
	</body>
</html>