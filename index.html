<html>
	<head>
		<link rel="stylesheet" type="text/css" 
			href="https://fonts.googleapis.com/css?family=Source Code Pro">
		<style>
			body {
				font-family: 'Source Code Pro', serif;
				font-size: 14px;
			}
						
            #repl_in {
				width: 100%;
            }
			
			#repl_out {
				white-space: pre-wrap;
			}
            
			.expr {
				font-weight: bold;
			}
		</style>
		<style>
        </style>		
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<script src="realtime.Sugar.js"></script>
	</head>
	<body>
		<button id="auth_button">Authorize</button>
		<div id="controls">
			<p>
				<textarea id="repl_in" type="text" rows="5"
					onkeypress="if(event.which === 10 && event.ctrlKey) repl_eval();"></textarea>
			</p>
			<p>
				<input type="button" value="Parse" onclick="repl_parse();"></input>
				<input type="button" value="Compile" onclick="repl_compile();"></input>
				<input type="button" value="Eval" onclick="repl_eval();"></input>
			</p>
        </div>
        <p id="repl_out"></p>  
		
		<script src="parser/parser.js"></script>
		<script src="compiler.js"></script>
		<script>
			function repl_parse(src) {
				if (src === undefined) {
					src = repl_in.value;
					repl_in.value = "";
				}
				repl_show(src, JSON.stringify(parser.parse(src)));
			}
			
			function repl_compile(src) {
				if (src === undefined) {
					src = repl_in.value;
					repl_in.value = "";
				}
				repl_show(src, compiler.compile(src));
			}
						
			function repl_eval(src) {
				if (src === undefined) {
					src = repl_in.value;
					repl_in.value = "";
				}
				repl_show(src, compiler.evaluate(src).toString());
			}
		
            function repl_show(expr, result) {
                var p = document.createElement("p");
				split(expr).forEach(function (line, index) {				
					var exprDiv = document.createElement("div");
					exprDiv.setAttribute("class", "expr");
					exprDiv.textContent = (index == 0 ? ">>  " : "    ") + line;
					p.appendChild(exprDiv);
				});
				split(result).forEach(function (line) {				
					var resDiv = document.createElement("div");
					resDiv.setAttribute("class", "result");
					resDiv.textContent = line;
					p.appendChild(resDiv);
				});
                repl_out.insertBefore(p, repl_out.firstChild);
            }
			
			function split(str) {
				return str.match(/[^\r\n]+/g);
			}
		</script>
		<script>
	var context;
	function setButton(){
	        var button = document.getElementById('auth_button');
			button.style.visibility="visible";
			button.addEventListener('click', authorize);
	}
	function unSetButton(){
	
	        var button = document.getElementById('auth_button');
			button.style.visibility="hidden";
            
	}
    function authorize() {
        // Attempt to authorize
        realtimeUtils.authorize(function(response){
          if(response.error){
            // Authorization failed because this is the first time the user has used your application,
            // show the authorize button to prompt them to authorize manually.
				setButton();
            }
           else {
			  unSetButton();
              start(initializeObjects);
          }
        },true);
	} 
	 authCallback=authorize;
      // startups the system
      function initializeObjects(model) {
	  
		context = CreateContext();
		 
		model.getRoot().set('context',context);
		
		context.set('object',CreateContext());
		
		//context.get('object').set('addMethod:',CreateMethod(
		//	'addMethod:',"(function(b){context.lookup('self').get().set(b.get('selector'),b); return context.lookup('self').get();})",context));
		
		context.get('object').set('basicNew', CreateMethod(
			'basicNew',"(function () { context.lookup('parent').set(context.lookup('self').get());context.lookup('self').set(context); return context;})",context));
			 
		context.get('object').set('addMethod:',CreateMethod(
			'addMethod:',"(function(b){context.lookup('self').get().set(b.get('selector'),b); return context.lookup('self').get();})",context));
			 
		openModelViewer();
		 
    }
    </script>
	<script>
	function HiveEval(context, str) {
		return eval(str);
	}
	function CreateMethod(selector,func,context)
	{ 
		var method= model.createMap();
		method.set('context',context);
		method.set('source',func);
		method.set("selector",selector);
		return method;
	}
	function CreateContext(parent)
	{
		var context = model.createMap();
		
		if(parent!=null)
		{
			context.set('parent',parent);
		}
		
	 
		return context;
	}
	
		
	</script>
	</body>
</html>