<html>
	<head>
		<link rel="stylesheet" type="text/css" 
			href="https://fonts.googleapis.com/css?family=Source Code Pro">
		<style>
			body {
				font-family: 'Source Code Pro', serif;
				font-size: 14px;
			}
						
            #repl_in {
				width: 100%;
            }
			
			#repl_out {
				white-space: pre-wrap;
			}
            
			.expr {
				font-weight: bold;
			}
		</style>
		<style>
        </style>		
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<script src="realtime.Sugar.js"></script>
	</head>
	<body>
		<button id="auth_button">Authorize</button>
		<div id="controls">
			<p>
				<textarea id="repl_in" type="text" rows="5"
					onkeypress="if(event.which === 10 && event.ctrlKey) repl_eval();"></textarea>
			</p>
			<p>
				<input type="button" value="Parse" onclick="repl_parse();"></input>
				<input type="button" value="Compile" onclick="repl_compile();"></input>
				<input type="button" value="Eval" onclick="repl_eval();"></input>
			</p>
        </div>
        <p id="repl_out"></p>  
		
		<script src="parser/parser.js"></script>
		<script src="compiler.js"></script>
		<script>
		var loaded=false;
			function repl_parse(src) {
				if (src === undefined) {
					src = repl_in.value;
					repl_in.value = "";
				}
				repl_show(src, JSON.stringify(parser.parse(src)));
			}
			
			function repl_compile(src) {
				if (src === undefined) {
					src = repl_in.value;
					repl_in.value = "";
				}
				repl_show(src, compiler.compile(src));
			}
						
			function repl_eval(src) {
				if(!loaded)
				{
					console.log("The system is not initialized yet.");
					return;
				}
				if (src === undefined) {
					src = repl_in.value;
					repl_in.value = "";
				}
				repl_show(src, compiler.evaluate(src).toString());
			}
		
            function repl_show(expr, result) {
                var p = document.createElement("p");
				split(expr).forEach(function (line, index) {				
					var exprDiv = document.createElement("div");
					exprDiv.setAttribute("class", "expr");
					exprDiv.textContent = (index == 0 ? ">>  " : "    ") + line;
					p.appendChild(exprDiv);
				});
				split(result).forEach(function (line) {				
					var resDiv = document.createElement("div");
					resDiv.setAttribute("class", "result");
					resDiv.textContent = line;
					p.appendChild(resDiv);
				});
                repl_out.insertBefore(p, repl_out.firstChild);
            }
			
			function split(str) {
				return str.match(/[^\r\n]+/g);
			}
		</script>
		<script>
	var context;
	function setButton(){
	        var button = document.getElementById('auth_button');
			button.style.visibility="visible";
			button.addEventListener('click', authorize);
	}
	function unSetButton(){
	
	        var button = document.getElementById('auth_button');
			button.style.visibility="hidden";
            
	}
    function authorize() {
        // Attempt to authorize
        realtimeUtils.authorize(function(response){
          if(response.error){
            // Authorization failed because this is the first time the user has used your application,
            // show the authorize button to prompt them to authorize manually.
				setButton();
            }
           else {
			  unSetButton();
              start(hiveLoaded);
          }
        },true);
	} 
	 authCallback=authorize;
	 function hiveLoaded(model){
		if(model.getRoot().get('context')==null)
		{initializeObjects();}
		openModelViewer();
		loaded=true;
	 }
      // startups the system
      function initializeObjects() {
	  
		context = CreateContext();
		 
		model.getRoot().set('context',context);
		
		context.set('object', model.createMap());
	 
		context.get('object').set('basicNew', CreateMethod(
			'basicNew',"(function () { var self =model.createMap();context.set('self',self); initObject(self,context);return self;})",context));
			
		InitializeNumbers();
		InitializeStrings();
		InitializeLists();
		InitializeOthers();
		

    }
	function InitializeNumbers()
	{
		compiler.evaluate("Number := object basicNew");
		context.get('Number').set('+', CreateMethod(
			'+',"(function (b) {return (context.lookup('self').get() + b);})",context));
		context.get('Number').set('/', CreateMethod(
			'/',"(function (b) {return (context.lookup('self').get() / b);})",context));
		

		compiler.evaluate("Number addMethod:[* b | self / (1/b) ]");
		compiler.evaluate("Number addMethod:[- b | self + (-1 * b) ]");
		context.get('Number').set('>', CreateMethod(
			'>',"(function (b) {if(context.lookup('self').get() > b){return context.lookup('true').get();}else{return context.lookup('false').get();}})",context));
		context.get('Number').set('<', CreateMethod(
			'<',"(function (b) {if(context.lookup('self').get() < b){return context.lookup('true').get();}else{return context.lookup('false').get();}})",context));
		
		compiler.evaluate("Number addMethod:[>= b | (self < b) not ]");
		
		compiler.evaluate("Number addMethod:[<= b | (self > b) not ]");
	 
		context.get('Number').set('toString',CreateMethod('toString',"(function(){ return CreateString(context.lookup('self').get().toString());})",context));
	}	
	function InitializeStrings()
	{
		compiler.evaluate("String := object basicNew");
		compiler.evaluate("String addMethod:[toString | self]");
		
		//concat
		context.get('String').set('+', CreateMethod(
			'+',"(function (b) {return (model.createString(context.lookup('self').get().toString() + b.receive('toString')().text));})",context));  
		//append
		context.get('String').set('+=', CreateMethod(
			'+=',"(function (b) {context.lookup('self').get().append(b.receive('toString')().text);return (context.lookup('self').get());})",context)); 
		//length
		context.get('String').set('length', CreateMethod(
			'length',"(function () {return (context.lookup('self').get().length);})",context)); 
		//toList
		context.get('String').set('toList', CreateMethod(
			'toList',"(function () {return (model.createList(context.lookup('self').get().text));})",context)); 
			
	}
	function InitializeLists()
	{
	
	}
	function InitializeOthers(){
		compiler.evaluate("Block := object basicNew");
		
		context.get('Block').set('new:', CreateMethod(
			'new:',"(function (method) { var self =context.lookup('object').get().receive('basicNew')(); self.set('value',method);return self;})",context));
		
		compiler.evaluate("true := (((object basicNew addMethod:[ifTrue:aBlock| aBlock value]) addMethod:[ifFalse:aBlock| ]) addMethod:[ifTrue: aBlock ifFalse: anotherBlock| aBlock value]) addMethod:[not| false]");
	
		compiler.evaluate("false := (((object basicNew addMethod:[ifTrue:aBlock| ]) addMethod:[ifFalse:aBlock| aBlock value]) addMethod:[ifTrue: aBlock ifFalse: anotherBlock| anotherBlock value])) addMethod:[not| false]");
	
	}
    </script>
	<script>
	function HiveEval(context, str) {
		return eval(str);
	}
	function initObject(obj,context)
	{
		obj.set('addMethod:',CreateMethod(
			'addMethod:',"(function(b){context.lookup('self').get().set(b.get('selector'),b); return context.lookup('self').get();})",context));
		obj.set('toString',CreateMethod('toString',"(function(){ return CreateString('An Object');})",context));
		obj.set('Equals:',CreateMethod(
			'Equals:',"(function(other){if(context.lookup('self').get()==other){return context.lookup('true').get();}else{return context.lookup('false').get();}})",context));
		
		
	}
	function CreateString( str)
	{return model.createString(str);}
	function CreateMethod(selector,func,context)
	{ 
		var method= model.createMap();
		method.set('context',context);
		method.set('source',func);
		method.set("selector",selector);
		return method;
	}
	function CreateContext(parent)
	{
		var context = model.createMap();
		
		if(parent!=null)
		{
			context.set('parent',parent);
		}
		
	 
		return context;
	}
	
		
	</script>
	</body>
</html>